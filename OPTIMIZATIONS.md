# Оптимизации кода - Решение проблем зависаний

## Проблема
Код зависал при создании графиков до критической ошибки компьютера из-за:
- Попытки подписать все ~118 элементов на каждом графике (472+ текстовых объекта)
- Высокое разрешение графиков (DPI=300)
- Отсутствие освобождения памяти после создания графиков
- Отсутствие базы данных для хранения результатов

## Внесённые изменения

### 1. Интеграция базы данных SQLite
- **Файл**: `atomic_data.db` (автоматически создаётся)
- **Таблица**: `elements` - хранит все рассчитанные данные атомов
- **Преимущества**:
  - Быстрая загрузка данных без пересчёта
  - Возможность SQL-запросов для анализа
  - Индексы для оптимизации поиска

### 2. Оптимизация построения графиков

#### Уменьшение количества подписей
- **Было**: Все 118 элементов подписаны на каждом графике
- **Стало**: Подписывается каждый N-й элемент (по умолчанию каждый 3-й)
- **Эффект**: Снижение количества текстовых объектов в ~3 раза (от 472 до ~157)

#### Снижение разрешения
- **Было**: DPI = 300 (очень высокое разрешение)
- **Стало**: DPI = 150 (по умолчанию, настраивается)
- **Эффект**: Снижение размера файлов и памяти в ~4 раза

#### Немедленное освобождение памяти
- **Было**: Все графики накапливались в памяти до `plt.show()`
- **Стало**: Каждая фигура закрывается сразу после сохранения
- **Эффект**: Память освобождается сразу после создания каждого графика

#### Использование неинтерактивного backend
- **Было**: Попытка отобразить графики в окне
- **Стало**: `matplotlib.use('Agg')` - только сохранение в файлы
- **Эффект**: Избежание проблем с отображением и дополнительной памяти

### 3. Аргументы командной строки

Программа теперь поддерживает настройку через аргументы:

```bash
python research_inertia.py --help
```

**Доступные опции**:
- `--force-reload` - Принудительный пересчёт данных
- `--no-db` - Не использовать базу данных
- `--label-every N` - Подписывать каждый N-й элемент (по умолчанию: 3)
- `--dpi N` - Разрешение изображений (по умолчанию: 150)
- `--skip-plots` - Пропустить построение графиков
- `--db-path PATH` - Путь к файлу базы данных

**Примеры использования**:

```bash
# Запуск с настройками по умолчанию
python research_inertia.py

# Больше подписей, выше качество (но медленнее)
python research_inertia.py --label-every 2 --dpi 200

# Меньше подписей для быстрого просмотра
python research_inertia.py --label-every 5 --dpi 100

# Только расчёт, без графиков
python research_inertia.py --skip-plots

# Принудительный пересчёт
python research_inertia.py --force-reload
```

## Ожидаемые результаты

### Производительность
- **Время построения графиков**: Снижено в ~3-5 раз
- **Использование памяти**: Снижено в ~4-6 раз
- **Размер файлов изображений**: Снижен в ~4 раза (при DPI=150)

### Качество
- Графики остаются читаемыми
- Важные элементы видны
- При необходимости можно увеличить плотность подписей

## Структура файлов

```
.
├── research_inertia.py         # Основной скрипт (оптимизирован)
├── requirements.txt            # Зависимости Python
├── atomic_data.db              # База данных (создаётся автоматически)
├── atomic_data_cache.json      # JSON кэш (для совместимости)
├── all_elements_analysis.png   # Основной график
├── k_distribution.png          # Гистограмма распределения
├── optimized_labels.png        # Дополнительный график
├── OPTIMIZATIONS.md            # Этот файл
└── experiments/                # Тестовые и экспериментальные скрипты
    ├── analysis.md             # Анализ причин зависания
    ├── database_schema.sql     # SQL схема базы данных
    └── test_optimizations.py   # Тесты оптимизаций
```

## Технические детали

### Функции базы данных
- `init_database()` - Инициализация БД
- `save_element_to_db()` - Сохранение элемента
- `load_elements_from_db()` - Загрузка всех элементов
- `get_db_metadata()` - Получение метаданных

### Изменённые функции
- `load_or_calculate_data()` - Добавлена поддержка БД
- `plot_all_elements_with_labels()` - Добавлены параметры для контроля подписей
- `plot_optimized_labels()` - Оптимизация памяти
- `main()` - Добавлена обработка аргументов командной строки

## Обратная совместимость

- JSON кэш всё ещё поддерживается
- Старые данные могут быть импортированы в БД
- При отсутствии БД код работает как раньше (но с оптимизациями графиков)

## Дальнейшие улучшения (опционально)

1. Добавить веб-интерфейс для просмотра данных
2. Реализовать интерактивные графики с возможностью приближения
3. Добавить экспорт данных в другие форматы (Excel, HDF5)
4. Параллельные вычисления для ускорения расчётов
